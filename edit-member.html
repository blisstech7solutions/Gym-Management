<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Edit Member</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>

<style>
:root{
  --primary:#ff2e63;
  --secondary:#08d9d6;
  --bg:#05070d;
  --card:#0f1424;
  --input:#0b1020;
  --error:#ff6b6b;
}

*{margin:0;padding:0;box-sizing:border-box;}

html,body{
  min-height:100vh;
  font-family:'Montserrat',sans-serif;
  background:var(--bg);
  color:#fff;
}

body{display:flex;flex-direction:column;}

.page-wrapper{
  flex:1;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.9)),
    url("https://images.unsplash.com/photo-1534438327276-14e5300c3a48") center/cover;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:40px 20px 100px;
}

.form-card{
  position:relative;
  width:100%;
  max-width:900px;
  background:var(--card);
  border-radius:26px;
  padding:42px 40px;
  box-shadow:0 40px 100px rgba(0,0,0,.9);
}

.close-btn{
  position:absolute;
  top:18px;
  right:18px;
  width:38px;
  height:38px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.close-btn i{color:#fff;font-size:18px;}

.form-title{text-align:center;margin-bottom:32px;}
.form-title h2{font-size:32px;font-weight:800;color:var(--primary);}
.form-title p{font-size:14px;color:#bbb;margin-top:6px;}

form{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:22px 24px;
}

.form-group{display:flex;flex-direction:column;}
.form-group.full{grid-column:1/-1;}

label{font-size:13px;font-weight:600;margin-bottom:8px;color:#ccc;}

input,select{
  height:48px;
  padding:0 16px;
  border-radius:12px;
  border:1px solid #1f2642;
  background:var(--input);
  color:#fff;
  font-size:14px;
}

input[readonly]{opacity:0.7;}

.error-text{
  color:var(--error);
  font-size:12px;
  margin-top:4px;
  display:none;
}

button{
  grid-column:1/-1;
  height:52px;
  margin-top:10px;
  border:none;
  border-radius:32px;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#000;
  font-weight:800;
  font-size:15px;
  cursor:pointer;
}

button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

#msg{
  grid-column:1/-1;
  text-align:center;
  margin-top:14px;
  font-weight:700;
}

footer{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#02030a;
  color:#aaa;
  text-align:center;
  padding:14px;
  font-size:13px;
}

@media(max-width:768px){
  form{grid-template-columns:1fr;}
  .form-card{padding:30px 22px;}
}
</style>
</head>

<body>

<div class="page-wrapper">
  <div class="form-card">

    <a href="./gym-dashboard.html" class="close-btn">
      <i class="fas fa-times"></i>
    </a>

    <div class="form-title">
      <h2>Edit Member</h2>
      <p>Update details or renew membership</p>
    </div>

    <form id="editForm">

      <div class="form-group">
        <label>Name</label>
        <input id="name"/>
        <span class="error-text" id="nameError"></span>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input id="email"/>
        <span class="error-text" id="emailError"></span>
      </div>

      <div class="form-group">
        <label>Mobile</label>
        <input id="mobile"/>
        <span class="error-text" id="mobileError"></span>
      </div>

      <div class="form-group">
        <label>Joining Date</label>
        <input type="date" id="joiningDate" readonly/>
      </div>

      <div class="form-group">
        <label>Duration</label>
        <select id="duration">
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="6">6</option>
          <option value="12">12</option>
        </select>
      </div>

      <div class="form-group">
        <label>Payment Amount</label>
        <input id="paymentAmount"/>
      </div>

      <div class="form-group">
        <label>Payment Status</label>
        <select id="paymentStatus">
          <option value="Paid">Paid</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <div class="form-group">
        <label>Current Renewal</label>
        <input type="date" id="renewalDate" readonly/>
      </div>

      <div class="form-group">
        <label>Renew Duration (Optional)</label>
        <select id="renewDuration">
          <option value="">-- Select --</option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="6">6</option>
          <option value="12">12</option>
        </select>
      </div>

      <div class="form-group">
        <label>New Renewal Date</label>
        <input type="date" id="newRenewalDate" readonly/>
      </div>

      <div class="form-group full">
        <label>Days Remaining</label>
        <input id="daysRemaining" readonly/>
      </div>

      <button type="submit" id="submitBtn">Update Member</button>
      <p id="msg"></p>

    </form>
  </div>
</div>

<footer>Â© 2025 BlissTech7 Solutions</footer>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCY5-w3jLyC9iXN8Kh26wGIVia1zGuGwyk",
  authDomain: "gym-management-50b12.firebaseapp.com",
  projectId: "gym-management-50b12",
  storageBucket: "gym-management-50b12.appspot.com",
  messagingSenderId: "202067078338",
  appId: "1:202067078338:web:6ad435b248f3230d7cdf5b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= CENTRAL FORM BINDING ========= */
const fields = {
  name: document.getElementById("name"),
  email: document.getElementById("email"),
  mobile: document.getElementById("mobile"),
  joiningDate: document.getElementById("joiningDate"),
  duration: document.getElementById("duration"),
  paymentAmount: document.getElementById("paymentAmount"),
  paymentStatus: document.getElementById("paymentStatus"),
  renewalDate: document.getElementById("renewalDate"),
  renewDuration: document.getElementById("renewDuration"),
  newRenewalDate: document.getElementById("newRenewalDate"),
  daysRemaining: document.getElementById("daysRemaining")
};

const submitBtn = document.getElementById("submitBtn");
const msg = document.getElementById("msg");

const params = new URLSearchParams(window.location.search);
const memberId = params.get("id");

function setLoading(state){
  submitBtn.disabled = state;
  submitBtn.textContent = state ? "Saving..." : "Update Member";
}

fields.renewDuration.addEventListener("change",()=>{
  if(!fields.renewDuration.value) return;
  const d = new Date(fields.renewalDate.value);
  d.setMonth(d.getMonth() + parseInt(fields.renewDuration.value));
  fields.newRenewalDate.value = d.toISOString().split("T")[0];
  fields.daysRemaining.value =
    Math.floor((d - new Date()) / (1000*3600*24)) + " days";
});

onAuthStateChanged(auth, async user=>{
  if(!user || !memberId){
    location.href="/index.html";
    return;
  }

  const ref = doc(db,"gyms",user.uid,"members",memberId);
  const snap = await getDoc(ref);
  const data = snap.data();

  Object.keys(fields).forEach(k=>{
    if(data[k]!==undefined && fields[k]) fields[k].value = data[k];
  });

  document.getElementById("editForm").addEventListener("submit", async e=>{
    e.preventDefault();
    setLoading(true);

    let finalRenewal = data.renewalDate;
    let finalDays = data.daysTotal;

    if(fields.renewDuration.value){
      finalRenewal = fields.newRenewalDate.value;
      finalDays = Math.floor(
        (new Date(finalRenewal) - new Date(fields.joiningDate.value)) /
        (1000*3600*24)
      );
    }

    await updateDoc(ref,{
      name: fields.name.value.trim(),
      email: fields.email.value.trim(),
      mobile: fields.mobile.value.trim(),
      joiningDate: fields.joiningDate.value,
      duration: fields.duration.value,
      paymentAmount: fields.paymentAmount.value,
      paymentStatus: fields.paymentStatus.value,
      renewalDate: finalRenewal,
      daysTotal: finalDays
    });

    msg.style.color="lime";
    msg.textContent="Member updated successfully";
    setTimeout(()=>location.href="./gym-dashboard.html",1500);
  });
});
</script>

</body>
</html>
