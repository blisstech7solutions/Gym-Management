<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gym Dashboard</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

<!-- Font Awesome (icons only) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#ff2e63;
  --secondary:#08d9d6;
  --dark:#06080f;
  --glass:rgba(255,255,255,0.08);
}

body,html{
  height:100%;
  margin:0;
  font-family:'Montserrat',sans-serif;
  background:#05070d;
  color:#fff;
  display:flex;
  flex-direction:column;
}

/* ================= GLOBAL STATES ================= */
.highlight{background:rgba(255,46,99,0.15)!important;}
.days-warning{background:#ff9800!important;color:#000;font-weight:700;}
.days-critical{background:#dc3545!important;color:#fff;font-weight:700;}

/* ================= HEADER ================= */
.dashboard-header{
  background:
    linear-gradient(to bottom,rgba(0,0,0,.55),rgba(0,0,0,.9)),
    url("https://images.unsplash.com/photo-1534438327276-14e5300c3a48") center/cover;
  border-radius:24px;
  padding:60px 25px;
  margin:20px;
}

.dashboard-header h2{
  font-weight:800;
  color:var(--primary);
}

/* ================= CONTAINER ================= */
.container-custom{
  max-width:1400px;
  margin:auto;
  padding:10px 20px 40px;
}

/* ================= ACTION BAR ================= */
.action-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:30px;
}

/* ================= TABLE ================= */
.table{
  background:var(--glass);
  backdrop-filter:blur(14px);
  border-radius:18px;
  color:#fff;
}

.table th{
  background:rgba(255,255,255,.15)!important;
  color:#fff;
  font-size:13px;
}

.table td{
  font-size:13px;
  vertical-align:middle;
}

/* ================= WHATSAPP ================= */
.whatsapp-button{
  background:#25D366;
  border:none;
  border-radius:30px;
  padding:6px 12px;
  display:inline-flex;
  align-items:center;
}
.whatsapp-icon{width:20px;height:20px;}

/* ================= MEMBER CARD (MOBILE) ================= */
.member-card{
  background:
    linear-gradient(to bottom,rgba(0,0,0,.5),rgba(0,0,0,.8)),
    url("https://images.unsplash.com/photo-1571019613578-2b1931c9b34b") center/cover;
  border-radius:22px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.member-card h5{
  color:var(--secondary);
  font-weight:700;
}
.member-card p{
  font-size:13px;
  color:#ddd;
}

/* ===== MOBILE ICON ACTIONS (ADDED) ===== */
.mobile-actions{
  display:flex;
  gap:12px;
  margin-top:14px;
}

.mobile-actions button{
  width:40px;
  height:40px;
  border-radius:50%;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  color:#fff;
}

.mobile-edit{background:#ffc107;color:#000;}
.mobile-delete{background:#dc3545;}
.mobile-whatsapp{background:#25D366;}

/* ================= FOOTER ================= */
.footer{
  background:#02030a;
  text-align:center;
  padding:18px;
  margin-top:auto;
  font-size:13px;
  color:#aaa;
}

/* ================= RESPONSIVE ================= */
@media (min-width:768px){
  #memberTable-container{display:block;}
  #memberCards{display:none;}
}
@media (max-width:767px){
  #memberTable-container{display:none;}
  #memberCards{display:block;}
}
/* ===== UNIFORM ACTION ICON BUTTONS ===== */
.btn.btn-sm,
.whatsapp-button{
  width:38px;
  height:38px;
  padding:0;
  border-radius:50%;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* Font Awesome icons */
.btn.btn-sm i{
  font-size:14px;
}

/* WhatsApp image icon */
.whatsapp-icon{
  width:18px;
  height:18px;
}

</style>
</head>

<body>

<div class="dashboard-header">
  <h2>Gym Dashboard</h2>
  <p id="gym-details"></p>
</div>


<div class="container-custom">

<div class="action-bar">
  <h4 class="m-0">My Gym Members</h4>

  <div class="d-flex gap-2 align-items-center flex-wrap">
    <!-- PAGE SWITCH BUTTONS -->
    <!-- <button class="btn btn-primary"
      onclick="location.href='gym-dashboard.html'">
      <i class="fas fa-users"></i> Members
    </button> -->

    <button class="btn btn-outline-primary"
      onclick="location.href='dashboard-analytics.html'">
      <i class="fas fa-chart-line"></i> Analytics
    </button>

  

    <button class="btn btn-warning" id="addMemberBtn">
      Add Member
    </button>
 <button class="btn btn-outline-danger" id="logoutBtn">
  <i class="fas fa-sign-out-alt"></i> 
</button>

  </div>
</div>


  <!-- DESKTOP TABLE -->
  <div id="memberTable-container">
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Joining</th>
          <th>Duration</th>
          <th>Renewal</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Remaining</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="member-list"></tbody>
    </table>
  </div>

  <!-- MOBILE CARDS -->
  <div id="memberCards" class="row row-cols-1 row-cols-md-2 row-cols-lg-3"></div>

</div>

<footer class="footer">
  © 2025 BlissTech7 Solutions | blisstech7solutions@gmail.com
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCY5-w3jLyC9iXN8Kh26wGIVia1zGuGwyk",
  authDomain: "gym-management-50b12.firebaseapp.com",
  projectId: "gym-management-50b12",
  storageBucket: "gym-management-50b12.appspot.com",
  messagingSenderId: "202067078338",
  appId: "1:202067078338:web:6ad435b248f3230d7cdf5b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUserId;

const calculateDaysRemaining = (renewalDate) => {
  const today = new Date();
  const rd = new Date(renewalDate);
  today.setHours(0,0,0,0);
  rd.setHours(0,0,0,0);
  const diff = Math.floor((rd - today) / (1000*60*60*24));
  return {
    renewalDaysRemaining: diff,
    displayText:
      diff < 0 ? `Expired ${Math.abs(diff)} days ago`
      : diff === 0 ? `Expires today`
      : `${diff} days`
  };
};

const renderMembers = (members) => {
  const tbody = document.getElementById("member-list");
  const cards = document.getElementById("memberCards");
  tbody.innerHTML = "";
  cards.innerHTML = "";

  members.forEach(m=>{
    const { renewalDaysRemaining, displayText } =
      calculateDaysRemaining(m.renewalDate);

    tbody.innerHTML += `
      <tr>
        <td>${m.name}</td>
        <td>${m.email}</td>
        <td>${m.mobile}</td>
        <td>${m.joiningDate}</td>
        <td>${m.duration}</td>
        <td>${m.renewalDate}</td>
        <td>${m.daysTotal} days</td>
        <td>₹${m.paymentAmount}</td>
        <td>${m.paymentStatus}</td>
        <td>${displayText}</td>
        <td>
        <button class="btn btn-sm btn-warning"
  onclick="location.href='edit-member.html?id=${m.id}'">
  <i class="fas fa-pen"></i>
</button>

<button class="btn btn-sm btn-danger"
  onclick="deleteMember('${m.id}')">
  <i class="fas fa-trash"></i>
</button>

<button class="whatsapp-button"
  onclick="sendWhatsApp('${m.mobile}','${m.name}','${renewalDaysRemaining}')">
  <img src="https://cdn-icons-png.flaticon.com/512/124/124034.png"
       class="whatsapp-icon">
</button>

        </td>
      </tr>`;

    cards.innerHTML += `
      <div class="col mb-4">
        <div class="member-card">
          <h5>${m.name}</h5>
          <p>Email: ${m.email}</p>
          <p>Mobile: ${m.mobile}</p>
          <p>Renewal: ${displayText}</p>

          <div class="mobile-actions">
            <button class="mobile-edit"
              onclick="location.href='edit-member.html?id=${m.id}'">
              <i class="fas fa-pen"></i>
            </button>
            <button class="mobile-delete"
              onclick="deleteMember('${m.id}')">
              <i class="fas fa-trash"></i>
            </button>
            <button class="mobile-whatsapp"
              onclick="sendWhatsApp('${m.mobile}','${m.name}','${renewalDaysRemaining}')">
              <i class="fab fa-whatsapp"></i>
            </button>
          </div>
        </div>
      </div>`;
  });
};

window.sendWhatsApp = (mob,name,days)=>{
  window.open(`https://wa.me/${mob}?text=Hello ${name}, expires in ${days} days`);
};

window.deleteMember = async (id)=>{
  if(confirm("Delete member?")){
    await deleteDoc(doc(db,"gyms",currentUserId,"members",id));
    loadMembers();
  }
};
const loadGymDetails = async () => {
  const gymDoc = await getDoc(doc(db,"gyms",currentUserId));
  if(gymDoc.exists()){
    const g = gymDoc.data();
    document.getElementById("gym-details").textContent =
      `${g.gymName} | ${g.address}`;
  }
};

const loadMembers = async ()=>{
  const snap = await getDocs(collection(db,"gyms",currentUserId,"members"));
  const arr=[];
  snap.forEach(d=>{
    let x=d.data();
    x.id=d.id;
    arr.push(x);
  });
  arr.sort((a, b) => {
  const da = calculateDaysRemaining(a.renewalDate).renewalDaysRemaining;
  const db = calculateDaysRemaining(b.renewalDate).renewalDaysRemaining;
  return da - db;
});

  renderMembers(arr);
};

onAuthStateChanged(auth, user => {
  if(user){
    currentUserId = user.uid;
    loadGymDetails();   // ✅ MUST BE HERE
    loadMembers();      // ✅ sorting + rendering
  } else {
    location.href = "index.html";
  }
});


$("#logoutBtn").click(()=>signOut(auth));
$("#addMemberBtn").click(()=>location.href="add-member.html");
</script>

</body>
</html>
